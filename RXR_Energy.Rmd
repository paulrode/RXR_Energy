---
title: "RXR Energy Analysis"
output: html_notebook
---


```{r, echo=FALSE, cache=TRUE}
#Load Tidy enviroment 
library("tidyverse")
library("dplyr")
library("stringr")
library("lubridate")
library("knitr")
library("kableExtra")
library("fpp2")
library("readxl")
```

The data comes from an hourly trend file of the building's aggregated electric utility meters. 

```{r, echo=FALSE}

#Need data.frame to have Date/Time, Aggregate Base Building Electric Use, Temperture, and Enthalpy; deleate all elce that may have been downloaded in the csv. 

read_csv("C:/Users/paulr/Documents/RXR_Energy/230 Park Avenue Total Building Electric (Curtailment).csv", col_names = TRUE) %>% select(c(1:2)) -> ies_elect_data


# Need to see if data time feacher is in dttm format, if not use the linte below. 
glimpse(ies_elect_data)
# mdy_hm(ies_elect_data$`Date`) -> ies_elect_data$`Date`

#Clean up feacher names to make reporting readable 
ies_elect_data <-  rename(ies_elect_data, Date = "Date/Time", "Electric" = "Total Building Electric (Curtailment)")

ies_elect_data %>% mutate(week = week(`Date`), year = year(`Date`)) %>% group_by(year, week) %>% summarise(total = sum(`Electric`, mininum = min(`Electric`))) -> ies_elect_data_week 

ies_elect_data %>% mutate(week = week(`Date`), year = year(`Date`)) %>% group_by(year, week) %>% summarise(baseload = min(`Electric`)) %>% mutate(baseload = baseload * 7 * 24) -> ies_elect_data_week_baseload

left_join(ies_elect_data_week, ies_elect_data_week_baseload) -> ies_elect_data_week

ies_elect_data_week %>% ggplot(aes(`week`, na.rm=TRUE)) +
  geom_line(aes(y=`baseload`, colour = "red")) +
  geom_line(aes(y=`total`, color = "blue"))

ies_elect_data %>% ggplot(aes(x=`Date`, y = `Electric`))+
  geom_line(aes(colour = "blue"), na.rm=TRUE)

glimpse(ies_elect_data)

```


```{r, echo=FALSE}
 
ies_elect_data %>% mutate(week = week(`Date`), year = year(`Date`), day = wday(`Date`), dateday = year * 100 + week * 10 + day) %>% group_by(year, week, day) -> ies_elect_data_day


ies_elect_data_day %>% ggplot(aes(x = week, y =  `TotalElectric`)) +
  geom_boxplot(aes(group =week))

ies_elect_data_day %>% mutate(month = month(`Date`)) %>% ggplot(aes(x = month, y =  `TotalElectric`)) +
  geom_boxplot(aes(group =month))

```

#just choose business hours
ies_data %>%
  mutate(hr = hour(ies_data$`Date/Time`)) %>%
  filter(hr>7 & hr<18)-> ies_data_business_hours

#make a timeseries 
ies_data_ts <- ts(ies_data_business_hours[,c(2:5)], start = c(2018, as.numeric(format(ies_data_business_hours$`Date/Time`, "%j"))), frequency = 365)


#Looking at relationships
GGally::ggpairs(ies_data_business_hours)
glimpse(ies_data_business_hours)
head(ies_data_ts, n=25)
     

#fit model
   tslm(ies_data_ts[,"Aggregate Base Building Electric Use"] ~ ies_data_ts[,"Total Occupancy"]) -> fit.ies_data_ts
autoplot(ies_data_ts[,"Aggregate Base Building Electric Use"] , series = "Data") +
  autolayer(fitted(fit.ies_data_ts), series = "Fitted") +
  xlab("Year") + ylab("NGas") +
  ggtitle("Fit comparision using trend and season on tslm")

#Check Fit
cbind(Data = ies_data_ts[,"Aggregate Base Building Electric Use"],
      Fitted = fitted(fit.ies_data_ts)) %>% 
  as.data.frame() %>%
  ggplot(aes(x=Data, y=Fitted)) +
  geom_point() +
  xlab("Fitted (predicted values)") +
  ylab("Data (actual values)") +
  ggtitle("Electric Relationships") + 
  geom_abline(intercept = 0, slope = 1)
checkresiduals(fit.ies_data_ts)
summary(fit.ies_data_ts)
