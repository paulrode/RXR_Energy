---
title: "NYC Portfolio"
output: html_notebook
---

# Electric   
Mission forecast electric consumption and cost for 2021. 

Approaches that will be tried. 
1. look at the historical bill information as a time series
2. try to deduct the constant load and the variable load. 
3. Looking at interval data extract the constant load and then report that and the variale load.  
4. Get rate cases and layer in cost to produce a full budget. 

Mission approach break down historical useage to constant load and variable load. 


The Costant load will be that we observed this past April 

```{r, echo=FALSE, results="hide", include=FALSE}
  # Enviroment 
  # Loading and preprocessing the data
  #Set up enviroment for R scrip  
  # Packages for tidyverse 
    library("tidyverse")
    library("lubridate")
  # Package for building tables in markdown and notebook 
    library("knitr")
    library("kableExtra") 
    library("xtable")
  # Package for forecasting
    library("fable")
  # Packages for reading excel and html files and XML
    library("openxlsx")
    library("XML")
  # Parkage for using data tables for very large data operations
    #library("data.table")
  #Package for reading fixed width tables
    library("utils")
  # Packages for reading data through API's 
    library("httr")
    library("jsonlite")
  # Package for performing inquires with SQL databases 
    library("sqldf")
  #Package for reading and writing to jpeg files
    library("jpeg")

  # Set proper working Dir 
    if (!getwd() == "C:/Users/paulr/Documents/RXR_Energy") {setwd("C:/Users/paulr/Documents/RXR_Energy")}

# Set proper working Dir
if (!getwd() == "C:/Users/paulr/Documents/RXR_Energy") {setwd("./RXR_Energy")}

# Check for data directory and if one is not present then make it
if (!file.exists("data")) {
  dir.create("data")
}

```

# Data from utility bills and degree days from NYSERDA 
Use the following to make a conditional join https://stackoverflow.com/questions/23095896/merging-two-dataframes-on-a-date-range-in-r



```{r, echo="FALSE", results='hide'}
#Read in data and fix formats

alldata <- read_csv("./data/MASTER METERING DATA(2).csv", col_names = TRUE, col_types = "cccccddcd")
alldata$`Start Date`<- mdy(alldata$`Start Date`)
alldata$`End Date` <- mdy(alldata$`End Date`)
alldata %>% mutate(Month = month(`Start Date`), Period = (alldata$`End Date`- alldata$`Start Date`)) %>% mutate(i = interval(ymd(`Start Date`), ymd(`End Date`))) -> alldata

# Summeraze data by building and utility to make a lookup table
alldata %>% group_by(Building, `Meter Type`, `Start Date`, `End Date`) %>% summarise(Usage = sum(Usage)) %>% mutate(Usage_Day = Usage / as.numeric(`End Date` - `Start Date`)) -> alldata

```




```{r, echo = "FALSE", results = 'hide'}
# Bring in DD and then join days per month to get a dataframe with DD/day to then combine with the main alldata
hdd <- read_csv("./data/NYSERDA HDD.csv")
colnames(hdd)[1] <- "Month"
hdd %>% select(1:5) %>% gather(key = "key", value = "HDD", -1) %>%
  mutate(datekey = paste(Month,key)) %>% select(datekey, HDD, -Month,-key) -> hdd

cdd <- read_csv("./data/NYSERDA CDD.csv")
colnames(cdd)[1] <- "Month"
cdd %>% select(1:5) %>% gather(key = "key", value = "CDD", -1) -> cdd

month_days <- data.frame(month = c(1:12), name = c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"), days = c(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31))


```


```{r,  echo=FALSE, results="hide", include=FALSE}
#Make a unique building vector
buildings <- unique(alldata$Building)

# Create a df with all days of the year for normarilizing useage per month

i <- 3


alldata %>% filter(Building == buildings[i] & `Meter Type` == "Electric") -> Elect

data.frame(dates = seq(as.Date(Elect$`Start Date`[1]), as.Date(Elect$`End Date`[length(Elect$`End Date`)]), by = "day"))  -> alldata_perday

# Using filters and brackets look up kWh/day for each day of the year 
upd <- data.frame(UsagePerDay = seq(1:length(alldata_perday$dates)))
for(i in 1:length(alldata_perday$dates)) {
  date <- alldata_perday$dates[i]
  as.numeric(filter(Elect, date > `Start Date` & date <= `End Date`)) -> Elect1
  Elect1[6] -> upd[i,1]
}
upd[1,1] <- Elect[1,6]
cbind(alldata_perday, upd) -> dailyElect
dailyElect %>% group_by(year(dates), month(dates)) %>% summarise(kWh = sum(UsagePerDay)) %>%
mutate("date" = ymd(paste(`year(dates)`, `month(dates)`, 15, sep = '-')))  ->
monthlyElect
monthlyElect %>% mutate("month" = month(date, label = TRUE, abbr = FALSE)) -> monthlyElect
colnames(monthlyElect) = c("year", "month1", "kWh", "date", "month")
monthlyElect %>% mutate(datekey = paste(month,year)) %>% select(datekey, kWh, date) %>% left_join(monthlyElect, hdd, by = "datekey" ) -> monthlyElect

#trim out covid months 
monthlyElect %>% filter(date < ymd("2020-03-15")) -> monthlyELectNoCovid

```
Apply forcast functions

```{r, echo=FALSE}
monthlyElect <- monthlyElect[-1,]

monthlyElect %>% ggplot(aes(x = date, y = kWh)) +
  geom_col() +
  geom_rect(aes(xmin = date[1], ymin = 0, xmax = date[length(monthlyElect$date) ], ymax = min(monthlyElect[-1,]$kWh)), color = "blue", fill = "blue", alpha = 0.01)






```



